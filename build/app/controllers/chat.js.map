{"version":3,"sources":["../src/app/controllers/chat.js"],"names":["connection","require","empty","cfg","cChat","list","req","res","next","email","query","page","undefined","limit","status","json","statusCode","message","offset","count","acquire","err","con","sql","data","release","code","dt","i","length","userId","firstName","lastName","email_","UserID_One","uidTwo","UserID_Two","UserTwoFirstname","UserTwoLastname","pp","UserTwoImage","photoProfileUrl","fullName","splitName","trim","split","initialName","charAt","uidOne","UserOneFirstname","UserOneLastname","UserOneImage","push","ConversationID","NewMessage","LastMessage","ReplyTransactTime","ReplyStatus","success","detail","conversationId","requestBy","receiver","ppSender","senderPhoto","fullNameSender","senderFirstname","senderLastname","splitNameSender","initialNameSender","ppReceiver","receiverPhoto","fullNameReceiver","receiverFirstname","receiverLastname","splitNameReceiver","initialNameReceiver","UserID","ReplyID","Reply","TransactTime","Status","send","body","sender","insertId","data2","getUserInfo","user_photo","user_firstname","user_lastname","toUpperCase","user_id","user_email","module","exports"],"mappings":"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","file":"chat.js","sourcesContent":["var connection = require('../../../config/db');\n\nvar empty = require('is-empty'),\n    cfg = require('../../../config');\n \nfunction cChat() {\n \n  this.list = function(req,res,next) {\n\n    var email = req.query.email;\n    var page = (req.query.page == undefined) ? 1 : req.query.page;\n    var limit = (req.query.limit == undefined) ? 20 : req.query.limit;\n\n    if(empty(email))\n      return res.status(500).json({statusCode:500,message: \"Parameter email is required\"});\n    \n    \n    var offset = (page - 1) * limit;\n    var count = \" LIMIT \"+offset+\",\"+limit;\n\n    \n\n    connection.acquire(function(err,con){\n      if (err) throw err;\n\n        var sql = \"SELECT   distinct c.ConversationID, \\\n                            c.UserID_One, \\\n                            m1.user_id as uidOne, m1.user_firstname as UserOneFirstname, m1.user_lastname as UserOneLastname, \\\n                            m1.user_photo As UserOneImage, \\\n                            c.UserID_Two, m2.user_firstname as UserTwoFirstname, m2.user_lastname as UserTwoLastname, \\\n                            m2.user_id as uidTwo, m2.user_photo As UserTwoImage, \\\n                            (SELECT count(*) from replies where status = 1 AND UserID <> '\"+email+\"' AND ConversationID = c.ConversationID) AS NewMessage, \\\n                            (SELECT Reply FROM replies WHERE ConversationID = c.ConversationID ORDER BY ReplyID DESC LIMIT 1) As LastMessage, \\\n                            (SELECT UserID FROM replies WHERE UserID <> '\"+email+\"' AND ConversationID = c.ConversationID ORDER BY TransactTime DESC LIMIT 1) As UserID, \\\n                            (SELECT TransactTime FROM replies WHERE ConversationID = c.ConversationID ORDER BY TransactTime DESC LIMIT 1) As ReplyTransactTime, \\\n                            (SELECT Status FROM replies WHERE ConversationID = c.ConversationID ORDER BY TransactTime DESC LIMIT 1) As ReplyStatus \\\n                  FROM conversations c \\\n                  inner join users m1 on m1.user_email = c.UserID_One \\\n                  inner join users m2 on m2.user_email = c.UserID_Two \\\n                  where (c.UserID_One = '\"+email+\"' and c.UserOneStatus <= 4) or (c.UserID_Two = '\"+email+\"' and c.UserTwoStatus <= 4) \\\n                  ORDER BY ReplyTransactTime DESC \"+count;\n\n        con.query(sql, function(err,data){\n          con.release();\n          if(err)\n              return res.status(500).json({statusCode:500,message: err.code});\n             \n          var dt = [];\n          for (var i = 0; i < data.length; i++) {\n\n              var userId = \"\";\n              var firstName = \"\";\n              var lastName = \"\";\n              var email_ = \"\";\n\n              //console.log(data[i].UserOneFirstname);\n\n              if(data[i].UserID_One == email){\n                userId = data[i].uidTwo;\n                email_ = data[i].UserID_Two;\n                firstName = data[i].UserTwoFirstname;\n                lastName = data[i].UserTwoLastname;\n                pp = (data[i].UserTwoImage) ? cfg.photoProfileUrl+''+data[i].UserTwoImage : null;\n\n                var fullName = data[i].UserTwoFirstname+' '+data[0].UserTwoLastname;\n\n                var splitName = fullName.trim().split(\" \");\n\n                if(splitName.length > 1){\n                  var initialName = splitName[0].charAt(0)+''+splitName[1].charAt(0);\n                }else{\n                  var initialName = splitName[0].charAt(0);\n                }\n\n              }else{\n                userId = data[i].uidOne;\n                email_ = data[i].UserID_One;\n                firstName = data[i].UserOneFirstname;\n                lastName = data[i].UserOneLastname;\n                pp = (data[i].UserOneImage) ? cfg.photoProfileUrl+''+data[i].UserOneImage : null;\n\n                var fullName = data[i].UserOneFirstname+' '+data[0].UserOneLastname;\n\n                var splitName = fullName.trim().split(\" \");\n\n                if(splitName.length > 1){\n                  var initialName = splitName[0].charAt(0)+''+splitName[1].charAt(0);\n                }else{\n                  var initialName = splitName[0].charAt(0);\n                } \n              }\n\n              dt.push({\n                \"conversationId\": data[i].ConversationID,\n                \"userId\": userId,\n                \"email\": email_,\n                \"firstName\": firstName,\n                \"lastName\": lastName,\n                \"photoURL\": pp,\n                \"initialName\": initialName,\n                \"newMessage\": data[i].NewMessage,\n                \"lastMessage\": data[i].LastMessage,\n                \"replyTransactTime\": data[i].ReplyTransactTime,\n                \"replyStatus\": data[i].ReplyStatus\n              });\n          }\n\n          return res.status(200).json({\n                                  statusCode:200,\n                                  success:true,\n                                  data:dt\n                              });\n \n      });\n    });\n  }\n\n  this.detail = function(req,res,next) {\n\n    var conversationId = req.query.conversationId;\n    var requestBy = req.query.requestBy;\n    var receiver = req.query.receiver;\n    var page = (req.query.page == undefined) ? 1 : req.query.page;\n    var limit = (req.query.limit == undefined) ? 20 : req.query.limit;\n\n    if(empty(conversationId))\n      return res.status(500).json({statusCode:500,message: \"Parameter conversationId is required\"});\n\n    if(empty(requestBy))\n      return res.status(500).json({statusCode:500,message: \"Parameter requestBy is required\"});\n\n    if(empty(receiver))\n      return res.status(500).json({statusCode:500,message: \"Parameter receiver is required\"});\n    \n    \n    var offset = (page - 1) * limit;\n    var count = \" LIMIT \"+offset+\",\"+limit;\n\n    \n\n    connection.acquire(function(err,con){\n      if (err) throw err;\n\n        var sql = \"SELECT   r.*,  \\\n                            m1.user_firstname as senderFirstname, m1.user_lastname as senderLastname, \\\n                            m1.user_photo As senderPhoto, \\\n                            m2.user_firstname as receiverFirstname, m2.user_lastname as receiverLastname, \\\n                            m2.user_photo As receiverPhoto \\\n                  FROM replies r \\\n                  inner join users m1 on m1.user_email = r.UserID \\\n                  inner join users m2 on m2.user_email = r.UserRecepient \\\n                  where ConversationID = '\"+conversationId+\"' \\\n                  ORDER BY TransactTime DESC \"+count;\n        \n        con.query(sql, function(err,data){\n          con.release();\n          if(err)\n              return res.status(500).json({statusCode:500,message: err.code});\n             \n          //console.log(data);\n          var dt = [];\n          for (var i = 0; i < data.length; i++) {\n\n              var ppSender = (data[i].senderPhoto) ? cfg.photoProfileUrl+''+data[i].senderPhoto : null;\n\n              var fullNameSender = data[i].senderFirstname+' '+data[i].senderLastname;\n\n              var splitNameSender = fullNameSender.trim().split(\" \");\n\n              if(splitNameSender.length > 1){\n                var initialNameSender = splitNameSender[0].charAt(0)+''+splitNameSender[1].charAt(0);\n              }else{\n                var initialNameSender = splitNameSender[0].charAt(0);\n              } \n\n\n              var ppReceiver = (data[i].receiverPhoto) ? cfg.photoProfileUrl+''+data[i].receiverPhoto : null;\n\n              var fullNameReceiver = data[i].receiverFirstname+' '+data[0].receiverLastname;\n\n              var splitNameReceiver = fullNameReceiver.trim().split(\" \");\n\n              if(splitNameReceiver.length > 1){\n                var initialNameReceiver = splitNameReceiver[0].charAt(0)+''+splitNameReceiver[1].charAt(0);\n              }else{\n                var initialNameReceiver = splitNameReceiver[0].charAt(0);\n              }\n\n              if(data[i].UserID == requestBy){ \n\n                dt.push({\n                  \"replyId\": data[i].ReplyID,\n                  \"conversationId\": data[i].ConversationID,\n                  \"message\": data[i].Reply,\n                  \"senderEmail\": data[i].UserID,\n                  \"senderFirstname\": data[i].senderFirstname,\n                  \"senderLastname\": data[i].senderLastname,\n                  \"photoURLSender\": ppSender,\n                  \"initialNameSender\": initialNameSender,\n                  \"receiverEmail\": data[i].receiver,\n                  \"receiverFirstname\": data[i].receiverFirstname,\n                  \"receiverLastname\": data[i].receiverLastname,\n                  \"photoURLReceiver\": ppReceiver,\n                  \"initialNameReceiver\": initialNameReceiver,\n                  \"transactTime\": data[i].TransactTime,\n                  \"replyStatus\": data[i].Status,\n                  \"from\": data[i].UserID,\n                  \"to\": receiver\n                });\n              \n              }else{\n\n                dt.push({\n                  \"replyId\": data[i].ReplyID,\n                  \"conversationId\": data[i].ConversationID,\n                  \"message\": data[i].Reply,\n                  \"senderEmail\": data[i].UserID,\n                  \"senderFirstname\": data[i].senderFirstname,\n                  \"senderLastname\": data[i].senderLastname,\n                  \"photoURLSender\": ppSender,\n                  \"initialNameSender\": initialNameSender,\n                  \"receiverEmail\": data[i].receiver,\n                  \"receiverFirstname\": data[i].receiverFirstname,\n                  \"receiverLastname\": data[i].receiverLastname,\n                  \"photoURLReceiver\": ppReceiver,\n                  \"initialNameReceiver\": initialNameReceiver,\n                  \"transactTime\": data[i].TransactTime,\n                  \"replyStatus\": data[i].Status,\n                  \"from\": data[i].UserID,\n                  \"to\": requestBy\n                });\n              }\n          }\n\n          return res.status(200).json({\n                                  statusCode:200,\n                                  success:true,\n                                  data:dt\n                              });\n \n      });\n    });\n  }\n\n  this.send = function(req,res,next) {\n\n    connection.acquire(function(err,con){\n      if (err) throw err;\n\n        var sql = \"INSERT INTO replies (Reply, UserID, UserRecepient, Status, \\\n            ConversationID,TransactTime) \\\n            VALUES ('\"+req.body.message+\"','\"+req.body.sender+\"','\"+req.body.receiver+\"',1,'\"+req.body.conversationId+\"', NOW())\";\n        \n        //console.log(sql);\n        con.query(sql, function(err,data){\n          con.release();\n          if(err)\n              return res.status(500).json({statusCode:500,message: err.code});\n             \n          \n          con.query(\"SELECT TransactTime FROM replies WHERE ReplyID = \"+data.insertId+\" LIMIT 1\", function(err,data2){\n            return res.status(200).json({\n                                  statusCode:200,\n                                  success:true,\n                                  data:{\"replyId\":data.insertId,\"transactTime\":data2[0].TransactTime}\n                              });\n            });\n        });\n\n    });\n  }\n\n  this.getUserInfo = function(req,res,next) {\n     connection.acquire(function(err,con){\n        if (err) throw err;\n\n          var sql = 'SELECT * FROM users WHERE user_email=\"'+req.query.email+'\" LIMIT 1';\n          //console.log(sql);\n          con.query(sql, function(err,data){\n            con.release();\n            if(err)\n                return res.status(500).json({statusCode:500,message: err.code});\n\n            if(data.length < 1){\n              res.status(404).json({statusCode:404,message: \"Data not found\"});\n            }else{\n              \n              var dt = [];\n              var pp = (data[0].user_photo) ? cfg.photoProfileUrl+''+data[0].user_photo : null;\n\n              var fullName = data[0].user_firstname+' '+data[0].user_lastname;\n\n              var splitName = fullName.trim().split(\" \");\n\n              if(splitName.length > 1){\n                var initialName = splitName[0].charAt(0)+''+splitName[1].charAt(0);\n              }else{\n                var initialName = splitName[0].charAt(0);\n              }\n\n              initialName = initialName.toUpperCase();\n\n              dt.push({\n                \"userId\": data[0].user_id,\n                \"email\": data[0].user_email,\n                \"firstName\": data[0].user_firstname,\n                \"lastName\": data[0].user_lastname,\n                \"initialName\": initialName,\n                \"photoUrl\": pp\n              });\n\n              //console.log(dt[0]);\n\n              return res.status(200).json({statusCode:200,success:true,data:dt[0]});\n            }\n        });\n     });\n  };\n\n  \n\n}\nmodule.exports = new cChat();\n"]}